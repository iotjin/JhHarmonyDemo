import { pinyin } from 'pinyin-pro';
import { BaseNavigation, JhProgressHUD, KColors } from 'JhCommon'
import { CitySelectModel } from './CitySelectModel'
import { CitySelectCell } from './CitySelectCell'
import data from '../../../res/china.json'


@Entry
@Preview
@Component
export struct CitySelectListPage {
  @State dataArr: ESObject[] = []
  // @State tagIndexList: string[] = ['ğŸ”', 'â˜…', 'A', 'B', 'C', 'D', 'E', 'F', 'G',
  //   'H', 'I', 'J', 'K', 'L', 'M', 'N',
  //   'O', 'P', 'Q', 'R', 'S', 'T', 'U',
  //   'V', 'W', 'X', 'Y', 'Z', '#']
  @State tagIndexList: string[] = []
  // scroller: Scroller = new Scroller()
  scroller: ListScroller = new ListScroller()
  searchController: SearchController = new SearchController()
  @State selectedIndex: number = 0
  @State isShowTagPopup: boolean = false
  @State contactsCount: string = ''

  aboutToAppear() {
    this.dataArr = this.loadData()
    // console.error('data', JSON.stringify(this.dataArr))

    let tempList: string[] = [];
    for (let i = 0; i < this.dataArr.length; i++) {
      const item: ESObject = this.dataArr[i];
      tempList.push(item['groupName'])
    }
    this.tagIndexList = tempList;
  }

  build() {
    Column() {
      BaseNavigation({
        isGradient: true,
        title: 'åŸå¸‚é€‰æ‹©åˆ—è¡¨',
        rightText: 'é€‰æ‹©',
        rightItemCallBack: () => {
        },
      })
      this.header()
      this.body()
    }
  }

  @Builder
  body() {
    Stack({ alignContent: Alignment.End }) {
      List({ space: 0, initialIndex: 0, scroller: this.scroller }) {
        ForEach(this.dataArr, (groupItem: ESObject, index: number) => {
          ListItemGroup({ header: this.itemHeader(groupItem.groupName) }) {
            ForEach(groupItem.data, (cellItem: string, index2: number) => {
              ListItem() {
                CitySelectCell({
                  index: index,
                  model: cellItem as CitySelectModel,
                  searchController: this.searchController,
                  onClickCell: (model: CitySelectModel) => {
                    console.error('ç‚¹å‡»cell', JSON.stringify(cellItem))
                    this.searchController.stopEditing()
                    this.clickCell(model.name!)
                  },
                  onClickTopCell: (model: ESObject) => {
                    this.searchController.stopEditing()
                    this.clickCell(model['name'])
                  },
                })
              }
            }, (item: string) => item)
          }
          // æ¯è¡Œä¹‹é—´çš„åˆ†ç•Œçº¿
          .divider({
            strokeWidth: 1,
            startMargin: 10,
            endMargin: 30,
            color: KColors.kFormLineColor,
          })
        })
        ListItem() {
          this.footer()
        }
      }
      .height('100%')
      .layoutWeight(1)
      .edgeEffect(EdgeEffect.Spring, {
        alwaysEnabled: true
      })
      .backgroundColor(Color.White)
      .sticky(StickyStyle.Header | StickyStyle.Footer)
      .scrollBar(BarState.Off)
      .onScrollIndex((firstIndex: number, lastIndex: number) => {
        // console.error('firstIndex', JSON.stringify(firstIndex))
        this.selectedIndex = firstIndex
      })

      AlphabetIndexer({ arrayValue: this.tagIndexList, selected: 0 })
        .color(Color.Black)// æ–‡å­—é¢œè‰²
        .selectedColor(Color.White)// é€‰ä¸­é¡¹æ–‡å­—é¢œè‰²
        .popupColor(Color.White)// æç¤ºå¼¹çª—æ–‡å­—é¢œè‰²
        .selectedBackgroundColor(KColors.kThemeColor)// é€‰ä¸­é¡¹èƒŒæ™¯é¢œè‰²
        .popupBackground('#C9C9C9')// æç¤ºå¼¹çª—èƒŒæ™¯è‰²
        .usingPopup(this.isShowTagPopup)// æ˜¯å¦ä½¿ç”¨æç¤ºå¼¹çª—
        .selectedFont({ size: 16, weight: FontWeight.Bolder })// é€‰ä¸­é¡¹å­—ä½“æ ·å¼
        .popupFont({ size: 30, weight: FontWeight.Bolder })// å¼¹å‡ºæ¡†å†…å®¹çš„å­—ä½“æ ·å¼
        .font({ size: 14 })// å­—æ¯ç´¢å¼•æ¡é»˜è®¤å­—ä½“æ ·å¼
        .itemSize(22)// å­—æ¯ç´¢å¼•æ¡å­—æ¯åŒºåŸŸå¤§å°
        .alignStyle(IndexerAlign.END)// å­—æ¯ç´¢å¼•æ¡å¼¹æ¡†çš„å¯¹é½æ ·å¼ï¼Œæ”¯æŒå¼¹çª—æ˜¾ç¤ºåœ¨ç´¢å¼•æ¡å³ä¾§å’Œå·¦ä¾§.é»˜è®¤å€¼: IndexerAlign.END
        .popupPosition({ x: 60, y: 48 })
        .itemBorderRadius(11)//ç´¢å¼•é¡¹èƒŒæ¿åœ†è§’åŠå¾„
        .popupBackgroundBlurStyle(BlurStyle.NONE)// è®¾ç½®æç¤ºå¼¹çª—çš„èƒŒæ™¯æ¨¡ç³Šæè´¨
        .selected(this.selectedIndex)
        .onSelect((index: number) => {
          // console.error('index', index)
          console.log(this.tagIndexList[index] + ' Selected!')
          // const findIndex = this.dataArr.findIndex((item: ESObject) => item['groupName'] == this.tagIndexList[index]);
          // console.error('findIndex', JSON.stringify(findIndex))
          this.scroller.scrollToIndex(index)
          this.isShowTagPopup = true;
          setTimeout(() => {
            this.isShowTagPopup = false;
          }, 3000)
        })
        .onPopupSelect((index: number) => {
          console.error('onPopupSelected:' + index)
        })
    }
    .layoutWeight(1)
  }

  @Builder
  itemHeader(text: string) {
    if (text == 'â˜…') {
      Row()
    } else {
      Row() {
        Text(text)
          .padding({ left: 15 })
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.isFloat(text) ? KColors.wxPayColor : '#777777')
      }
      .width("100%")
      .height(30)
      .backgroundColor(KColors.wxBgColor)
    }
  }

  isFloat(text: string) {
    return this.tagIndexList[this.selectedIndex] == text
  }

  @Builder
  header() {
    Row() {
      Text('çƒ­é—¨åŸå¸‚')
      Text() {
        SymbolSpan($r('sys.symbol.local_fill'))
          .fontWeight(FontWeight.Bold)
          .fontSize(18)
          .fontColor([Color.Green])
        Span(' æˆéƒ½å¸‚')
      }
    }
    .width('100%')
    .height(50)
    .padding(10)
    .justifyContent(FlexAlign.SpaceBetween)
  }

  @Builder
  footer() {
    Row() {
      Text(`${this.getData().length} ä¸ªåŸå¸‚`)
        .fontSize(16)
        .fontColor(Color.Gray)
    }
    .width('100%')
    .height(50)
    .justifyContent(FlexAlign.Center)
    .backgroundColor(KColors.wxBgColor)
  }

  clickCell(text: string) {
    console.error('ç‚¹å‡»', JSON.stringify(text))
    JhProgressHUD.showToast(text)
  }

  loadData() {
    // åŸå§‹æ•°æ®
    const dataArr: ESObject[] = this.getData()

    // å¤„ç†æ•°æ®
    let tempList: ESObject[] = [];
    for (let i = 0; i < dataArr.length; i++) {
      const item: ESObject = dataArr[i]
      const pinyinStr = pinyin(item.name, { toneType: 'none' })
      const tag = pinyinStr.substring(0, 1).toUpperCase();
      item.namePinyin = pinyinStr;
      if (new RegExp('[A-Z]').test(tag)) {
        item.tagIndex = tag;
      } else {
        item.tagIndex = '#';
      }
      tempList.push(item);
    }

    // æ ¹æ®A-Zæ’åº
    tempList.sort((a: ESObject, b: ESObject) => {
      if (a['tagIndex'] === b['tagIndex']) {
        return a['name'].localeCompare(b['name']) as number
      }
      if (a['tagIndex'] === "#") {
        return 1
      }
      if (b['tagIndex'] === "#") {
        return -1
      }
      return a['tagIndex'].localeCompare(b['tagIndex']) as number
    });

    // æŠŠæ˜Ÿæ ‡ç§»åˆ°æœ€å‰
    tempList.forEach((item: ESObject, index) => {
      if (item.isStar == true) {
        tempList.unshift(...tempList.splice(index, 1));
      }
    });

    // æ·»åŠ  header
    tempList.unshift({
      name: "header",
      tagIndex: "â˜…"
    });

    // æ”¹æˆåˆ†ç»„æ•°æ®
    const newArr: ESObject[] = groupListByKey(tempList, 'tagIndex');
    return newArr
  }

  getData() {
    let dataArr: ESObject[] = data['china']
    return dataArr;
  }
}

// æ•°ç»„æŒ‰æŒ‡å®škeyåˆ†ç»„
function groupListByKey<T>(array: T[], key: string): ESObject[] {
  const result: ESObject[] = [];
  const groupMap: Map<string, T[]> = new Map();

  // éå†æ•°ç»„ï¼Œå°†æ¯ä¸ªå…ƒç´ æŒ‰ç…§keyåˆ†ç»„
  array.forEach((item: ESObject) => {
    const groupValue = String(item[key]);
    if (!groupMap[groupValue]) {
      groupMap[groupValue] = [];
    }
    groupMap[groupValue].push(item);
  });

  Object.keys(groupMap).forEach((key) => {
    result.push({ groupName: key, data: groupMap[key] });
  });
  return result;
}
